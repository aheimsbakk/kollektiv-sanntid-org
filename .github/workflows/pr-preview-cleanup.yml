name: PR Preview Cleanup

on:
  pull_request:
    types: [closed]
    branches: ["main"]

permissions:
  deployments: write
  pull-requests: write

jobs:
  cleanup-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Delete preview environment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const envName = `pr-preview-${prNumber}`;
            
            try {
              // Get all deployments for this environment
              const { data: deployments } = await github.rest.repos.listDeployments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                environment: envName
              });
              
              // Mark all deployments as inactive
              for (const deployment of deployments) {
                await github.rest.repos.createDeploymentStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id,
                  state: 'inactive'
                });
                
                // Delete the deployment
                await github.rest.repos.deleteDeployment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id
                });
              }
              
              // Delete the environment
              await github.rest.repos.deleteAnEnvironment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                environment_name: envName
              });
              
              console.log(`‚úÖ Cleaned up environment: ${envName}`);
              
              // Comment on PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## üßπ Preview deployment cleaned up\n\nThe preview environment \`${envName}\` has been removed.`
              });
              
            } catch (error) {
              console.log(`‚ö†Ô∏è Error cleaning up environment ${envName}:`, error.message);
              // Don't fail the workflow if cleanup fails
            }
