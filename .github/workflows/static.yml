# Deploy main site to previews branch root
name: Deploy static content to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: write

# Allow only one concurrent deployment
concurrency:
  group: "pages-main"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          path: main-source

      - name: Checkout previews branch
        uses: actions/checkout@v4
        with:
          ref: previews
          path: previews-branch

      - name: Deploy main site to previews branch root
        run: |
          # Remove old root files (but keep pr-* folders)
          cd previews-branch
          find . -maxdepth 1 -type f -not -name '.git*' -delete
          
          # Copy src/ to root (this becomes the main site)
          cp -r ../main-source/src/* .
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit and push
          git add .
          if git diff --staged --quiet; then
            echo "No changes to main site"
          else
            git commit -m "Deploy main site from ${GITHUB_SHA::7}"
            git push origin previews
          fi
