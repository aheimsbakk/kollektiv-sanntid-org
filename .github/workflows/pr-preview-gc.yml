name: PR Preview Garbage Collection

on:
  schedule:
    - cron: "0 0 * * 0" # Every Sunday at midnight UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  gc-previews:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Remove orphaned pr-* folders
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          DELETED=()

          for dir in pr-*/; do
            # Strip trailing slash ‚Üí pr-42
            folder="${dir%/}"
            pr_number="${folder#pr-}"

            # Skip if not a number
            if ! [[ "$pr_number" =~ ^[0-9]+$ ]]; then
              echo "‚ö†Ô∏è  Skipping unexpected folder: $folder"
              continue
            fi

            # Query PR state via GitHub CLI
            state=$(gh pr view "$pr_number" \
              --repo "${{ github.repository }}" \
              --json state \
              --jq '.state' 2>/dev/null || echo "NOTFOUND")

            if [ "$state" = "OPEN" ]; then
              echo "‚úÖ PR #${pr_number} is still open ‚Äî keeping $folder"
            else
              echo "üóëÔ∏è  PR #${pr_number} is ${state} ‚Äî removing $folder"
              rm -rf "$folder"
              DELETED+=("$folder")
            fi
          done

          if [ ${#DELETED[@]} -eq 0 ]; then
            echo "Nothing to clean up."
            exit 0
          fi

          # Pull before staging (avoid rebase discarding staged files)
          git pull --rebase --autostash

          git add .
          git commit -m "GC: remove orphaned PR previews: ${DELETED[*]}"
          git push

          echo "Removed: ${DELETED[*]}"
